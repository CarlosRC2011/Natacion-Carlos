f<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AquaLog ‚Äî Mi Diario de Nataci√≥n</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #050E1A;
  --surface: #0B1929;
  --surface2: #112236;
  --border: #1E3A5F;
  --accent: #00C6FF;
  --accent2: #0072FF;
  --gold: #FFD700;
  --red: #FF4D6D;
  --green: #00E5A0;
  --text: #E8F4FF;
  --muted: #5A8AAA;
  --sidebar-w: 220px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  overflow: hidden;
}

/* ===== LOADING SCREEN ===== */
#loading-screen {
  position: fixed; inset: 0;
  background: var(--bg);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 1000;
  gap: 16px;
}
.loading-logo { font-family: 'Bebas Neue', sans-serif; font-size: 3rem; letter-spacing: 4px; background: linear-gradient(135deg,var(--accent),var(--accent2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.loading-spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { font-size: 0.8rem; color: var(--muted); letter-spacing: 2px; }

/* ===== ADMIN BAR ===== */
#admin-bar {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--surface2);
  border-top: 1px solid var(--border);
  padding: 10px 20px;
  display: flex; align-items: center; justify-content: space-between;
  z-index: 50;
  font-size: 0.8rem;
}
#admin-bar.admin-active { border-top-color: var(--gold); }
.admin-status { display: flex; align-items: center; gap: 8px; color: var(--muted); }
.admin-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); }
.admin-dot.on { background: var(--gold); box-shadow: 0 0 8px var(--gold); }
.admin-btn { padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border); background: none; color: var(--muted); cursor: pointer; font-family: 'Outfit', sans-serif; font-size: 0.78rem; transition: all 0.2s; }
.admin-btn:hover { border-color: var(--gold); color: var(--gold); }
.admin-btn.exit { border-color: var(--red); color: var(--red); }
.admin-btn.exit:hover { background: rgba(255,77,109,0.1); }

/* ===== SIDEBAR ===== */
#sidebar {
  width: var(--sidebar-w);
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  flex-shrink: 0;
  position: relative; z-index: 10;
}
.sidebar-logo { padding: 28px 20px 20px; border-bottom: 1px solid var(--border); }
.logo-title { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; letter-spacing: 2px; background: linear-gradient(135deg,var(--accent),var(--accent2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; line-height:1; }
.logo-sub { font-size: 0.65rem; color: var(--muted); letter-spacing: 3px; text-transform: uppercase; margin-top: 2px; }
.swimmer-icon { font-size: 1.4rem; margin-bottom: 6px; display: block; }
nav { flex: 1; padding: 16px 12px; display: flex; flex-direction: column; gap: 4px; }
.nav-section-label { font-size: 0.6rem; color: var(--muted); letter-spacing: 3px; text-transform: uppercase; padding: 10px 8px 4px; margin-top: 8px; }
.nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 0.88rem; font-weight: 500; color: var(--muted); border: 1px solid transparent; }
.nav-item:hover { background: var(--surface2); color: var(--text); }
.nav-item.active { background: linear-gradient(135deg,rgba(0,198,255,0.15),rgba(0,114,255,0.08)); color: var(--accent); border-color: rgba(0,198,255,0.25); }
.nav-item .icon { font-size: 1rem; width: 20px; text-align: center; }
.admin-only-nav { display: none; }
.admin-only-nav.show { display: block; }
.sidebar-footer { padding: 16px 20px; border-top: 1px solid var(--border); font-size: 0.72rem; color: var(--muted); text-align: center; }

/* ===== MAIN ===== */
#main { flex: 1; overflow-y: auto; display: flex; flex-direction: column; padding-bottom: 52px; }
.topbar { padding: 20px 32px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--surface); position: sticky; top: 0; z-index: 5; }
.page-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.6rem; letter-spacing: 2px; color: var(--accent); }
.topbar-right { display: flex; align-items: center; gap: 12px; }

.btn { padding: 8px 18px; border-radius: 6px; border: none; cursor: pointer; font-family: 'Outfit', sans-serif; font-size: 0.82rem; font-weight: 600; transition: all 0.2s; letter-spacing: 0.5px; }
.btn-primary { background: linear-gradient(135deg,var(--accent),var(--accent2)); color: #fff; }
.btn-primary:hover { opacity: 0.85; transform: translateY(-1px); }
.btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--muted); }
.btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
.btn-danger { background: transparent; border: 1px solid var(--red); color: var(--red); font-size: 0.75rem; padding: 5px 10px; }
.btn-danger:hover { background: rgba(255,77,109,0.1); }
.admin-action { display: none; }
.admin-action.show { display: inline-flex; }
.admin-action-block { display: none; }
.admin-action-block.show { display: block; }

.content { padding: 28px 32px; flex: 1; }
.page { display: none; }
.page.active { display: block; animation: fadeUp 0.3s ease; }
@keyframes fadeUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }

/* ===== STATS ===== */
.stats-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-bottom: 28px; }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; position: relative; overflow: hidden; }
.stat-card::before { content:''; position:absolute; top:0;left:0;right:0; height:2px; background:linear-gradient(90deg,var(--accent),var(--accent2)); }
.stat-label { font-size: 0.72rem; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 8px; }
.stat-value { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; letter-spacing: 1px; color: var(--text); line-height: 1; }
.stat-sub { font-size: 0.72rem; color: var(--muted); margin-top: 4px; }
.stat-card.gold::before { background: var(--gold); }
.stat-card.green::before { background: var(--green); }
.stat-card.red::before { background: var(--red); }

.section-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 2px; color: var(--muted); margin-bottom: 14px; text-transform: uppercase; }

.recent-table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 28px; }
table { width: 100%; border-collapse: collapse; }
thead { background: var(--surface2); }
th { padding: 12px 16px; text-align: left; font-size: 0.7rem; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); font-weight: 600; }
td { padding: 13px 16px; font-size: 0.88rem; border-top: 1px solid var(--border); vertical-align: middle; }
tr:hover td { background: rgba(0,198,255,0.03); }

.badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.5px; }
.badge-blue { background: rgba(0,198,255,0.15); color: var(--accent); border: 1px solid rgba(0,198,255,0.3); }
.badge-gold { background: rgba(255,215,0,0.12); color: var(--gold); border: 1px solid rgba(255,215,0,0.3); }
.badge-green { background: rgba(0,229,160,0.12); color: var(--green); border: 1px solid rgba(0,229,160,0.3); }
.badge-red { background: rgba(255,77,109,0.12); color: var(--red); border: 1px solid rgba(255,77,109,0.3); }
.badge-gray { background: rgba(90,138,170,0.12); color: var(--muted); border: 1px solid var(--border); }
.time-value { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 1px; }
.pb-tag { font-size: 0.65rem; color: var(--gold); margin-left: 6px; }

/* ===== FORMS ===== */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
.form-grid.cols3 { grid-template-columns: 1fr 1fr 1fr; }
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-group.full { grid-column: 1 / -1; }
label { font-size: 0.75rem; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; font-weight: 600; }
input, select, textarea { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; color: var(--text); font-family: 'Outfit', sans-serif; font-size: 0.9rem; transition: border-color 0.2s; width: 100%; }
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,198,255,0.08); }
select option { background: var(--surface2); }
textarea { resize: vertical; min-height: 80px; }
.form-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 20px; }
.form-card-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.05rem; letter-spacing: 2px; color: var(--accent); margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
.form-actions { display: flex; gap: 10px; padding-top: 4px; }

/* ===== RECORDS ===== */
.records-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 16px; }
.record-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
.record-event { font-size: 0.7rem; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 4px; }
.record-time { font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem; letter-spacing: 2px; color: var(--gold); line-height: 1; }
.record-date { font-size: 0.72rem; color: var(--muted); margin-top: 6px; }
.record-min { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
.record-min-label { font-size: 0.65rem; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }
.record-min-val { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; color: var(--accent); }
.diff-tag { font-size: 0.75rem; margin-top: 4px; }
.diff-pos { color: var(--red); }
.diff-neg { color: var(--green); }

/* ===== COMPS ===== */
.comp-list { display: flex; flex-direction: column; gap: 14px; }
.comp-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px 24px; display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: start; transition: border-color 0.2s; }
.comp-card:hover { border-color: rgba(0,198,255,0.3); }
.comp-name { font-weight: 700; font-size: 1rem; margin-bottom: 4px; }
.comp-meta { font-size: 0.8rem; color: var(--muted); display: flex; gap: 16px; }
.comp-results { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; }
.comp-result-tag { display: flex; align-items: center; gap: 6px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 5px 10px; font-size: 0.78rem; }
.comp-result-tag .ev { color: var(--muted); }
.comp-result-tag .tm { font-family: 'Bebas Neue', sans-serif; font-size: 1rem; color: var(--accent); letter-spacing: 1px; }
.comp-actions { display: flex; gap: 8px; }

/* ===== M√çNIMOS ===== */
.min-table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
.progress-bar-wrap { display: flex; align-items: center; gap: 10px; }
.progress-bar-bg { flex: 1; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
.progress-bar-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg,var(--accent),var(--accent2)); transition: width 0.5s ease; }
.progress-pct { font-size: 0.75rem; color: var(--muted); min-width: 40px; text-align: right; }

.empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
.empty-state .empty-icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.4; }
.empty-state p { font-size: 0.88rem; }

/* ===== MODAL (admin login) ===== */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(5,14,26,0.9); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(6px); }
.modal-overlay.show { display: flex; }
.modal { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 32px; width: 90%; max-width: 380px; animation: fadeUp 0.25s ease; text-align: center; }
.modal-icon { font-size: 2.5rem; margin-bottom: 12px; }
.modal-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; letter-spacing: 2px; color: var(--accent); margin-bottom: 6px; }
.modal-sub { font-size: 0.82rem; color: var(--muted); margin-bottom: 24px; }
.modal input { text-align: center; font-size: 1rem; letter-spacing: 4px; margin-bottom: 16px; }
.modal-error { color: var(--red); font-size: 0.8rem; margin-top: -8px; margin-bottom: 12px; display: none; }
.modal-error.show { display: block; }
.modal-actions { display: flex; gap: 10px; }
.modal-actions .btn { flex: 1; }

/* ===== TOAST ===== */
.toast { position: fixed; bottom: 64px; right: 24px; background: var(--green); color: #001a0d; padding: 12px 20px; border-radius: 8px; font-weight: 600; font-size: 0.85rem; z-index: 300; transform: translateY(80px); opacity: 0; transition: all 0.3s; }
.toast.show { transform: translateY(0); opacity: 1; }

/* ===== SYNCING indicator ===== */
.sync-indicator { font-size: 0.72rem; color: var(--muted); display: flex; align-items: center; gap: 6px; }
.sync-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); }
.sync-dot.syncing { background: var(--gold); animation: pulse 1s infinite; }
.sync-dot.error { background: var(--red); }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

@media (max-width:900px) {
  :root { --sidebar-w: 64px; }
  .nav-item span:not(.icon) { display: none; }
  .nav-section-label, .logo-sub, .logo-title { display: none; }
  .swimmer-icon { font-size: 1.6rem; }
  .sidebar-logo { padding: 20px 12px; text-align: center; }
  .stats-grid { grid-template-columns: 1fr 1fr; }
  .records-grid { grid-template-columns: 1fr 1fr; }
  .content { padding: 20px 16px; }
  .topbar { padding: 16px; }
  .form-grid { grid-template-columns: 1fr; }
  .form-grid.cols3 { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading-screen">
  <div class="loading-logo">üèä AquaLog</div>
  <div class="loading-spinner"></div>
  <div class="loading-text">Conectando con Firebase...</div>
</div>

<!-- ADMIN LOGIN MODAL -->
<div class="modal-overlay" id="admin-modal">
  <div class="modal">
    <div class="modal-icon">üîê</div>
    <div class="modal-title">Modo Admin</div>
    <div class="modal-sub">Introduce tu contrase√±a para editar los datos</div>
    <input type="password" id="admin-password-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')checkPassword()" />
    <div class="modal-error" id="modal-error">Contrase√±a incorrecta</div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeAdminModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="checkPassword()">Entrar</button>
    </div>
  </div>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
  <div class="sidebar-logo">
    <span class="swimmer-icon">üèä</span>
    <div class="logo-title">AquaLog</div>
    <div class="logo-sub">Diario de Nataci√≥n</div>
  </div>
  <nav>
    <span class="nav-section-label">Principal</span>
    <div class="nav-item active" onclick="navigate('dashboard')"><span class="icon">üìä</span><span>Dashboard</span></div>
    <div class="nav-item" onclick="navigate('tiempos')"><span class="icon">‚è±Ô∏è</span><span>Mis Tiempos</span></div>
    <div class="nav-item" onclick="navigate('competiciones')"><span class="icon">üèÜ</span><span>Competiciones</span></div>
    <span class="nav-section-label">An√°lisis</span>
    <div class="nav-item" onclick="navigate('marcas')"><span class="icon">‚≠ê</span><span>Marcas Personales</span></div>
    <div class="nav-item" onclick="navigate('minimos')"><span class="icon">üéØ</span><span>M√≠nimos</span></div>
    <div class="admin-only-nav" id="nav-admin-section">
      <span class="nav-section-label">Admin</span>
      <div class="nav-item" onclick="navigate('add-tiempo')"><span class="icon">‚ûï</span><span>A√±adir Tiempo</span></div>
      <div class="nav-item" onclick="navigate('add-comp')"><span class="icon">üìÖ</span><span>Nueva Competici√≥n</span></div>
      <div class="nav-item" onclick="navigate('add-minimo')"><span class="icon">üéØ</span><span>A√±adir M√≠nimo</span></div>
    </div>
  </nav>
  <div class="sidebar-footer">v2.0 ¬∑ AquaLog</div>
</div>

<!-- MAIN -->
<div id="main">
  <div class="topbar">
    <div class="page-title" id="page-title">Dashboard</div>
    <div class="topbar-right">
      <div class="sync-indicator"><div class="sync-dot" id="sync-dot"></div><span id="sync-text">Sincronizado</span></div>
      <button class="btn btn-primary admin-action" id="topbar-add-btn" onclick="navigate('add-tiempo')">+ Nuevo tiempo</button>
    </div>
  </div>

  <div class="content">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Total Tiempos</div><div class="stat-value" id="stat-total">‚Äî</div><div class="stat-sub">registros guardados</div></div>
        <div class="stat-card gold"><div class="stat-label">Marcas Personales</div><div class="stat-value" id="stat-pbs">‚Äî</div><div class="stat-sub">pruebas diferentes</div></div>
        <div class="stat-card green"><div class="stat-label">Competiciones</div><div class="stat-value" id="stat-comps">‚Äî</div><div class="stat-sub">registradas</div></div>
        <div class="stat-card red"><div class="stat-label">M√≠nimos</div><div class="stat-value" id="stat-mins">‚Äî</div><div class="stat-sub">objetivos definidos</div></div>
      </div>
      <div class="section-title">‚è±Ô∏è √öltimos tiempos registrados</div>
      <div class="recent-table-wrap">
        <table>
          <thead><tr><th>Fecha</th><th>Prueba</th><th>Piscina</th><th>Tiempo</th><th>Tipo</th><th>Nota</th></tr></thead>
          <tbody id="dashboard-table"><tr><td colspan="6"><div class="empty-state"><div class="empty-icon">üåä</div><p>Cargando datos...</p></div></td></tr></tbody>
        </table>
      </div>
      <div class="section-title">üèÜ Pr√≥ximas competiciones</div>
      <div id="dashboard-comps"><div class="empty-state" style="padding:30px"><div class="empty-icon">üìÖ</div><p>Cargando...</p></div></div>
    </div>

    <!-- MIS TIEMPOS -->
    <div class="page" id="page-tiempos">
      <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;align-items:center;">
        <select id="filter-prueba" onchange="renderTiempos()" style="max-width:200px"><option value="">Todas las pruebas</option></select>
        <select id="filter-piscina" onchange="renderTiempos()" style="max-width:180px">
          <option value="">Todas las piscinas</option>
          <option value="25m">Piscina corta (25m)</option>
          <option value="50m">Piscina larga (50m)</option>
        </select>
        <select id="filter-tipo" onchange="renderTiempos()" style="max-width:180px">
          <option value="">Todos los tipos</option>
          <option value="entrenamiento">Entrenamiento</option>
          <option value="competicion">Competici√≥n</option>
          <option value="crono">Cronometrado</option>
        </select>
      </div>
      <div class="recent-table-wrap">
        <table>
          <thead><tr><th>Fecha</th><th>Prueba</th><th>Piscina</th><th>Tiempo</th><th>Tipo</th><th>Lugar</th><th>Nota</th><th class="admin-action" id="th-delete"></th></tr></thead>
          <tbody id="tiempos-table"></tbody>
        </table>
      </div>
    </div>

    <!-- COMPETICIONES -->
    <div class="page" id="page-competiciones">
      <div class="comp-list" id="comp-list">
        <div class="empty-state"><div class="empty-icon">üèÜ</div><p>Cargando competiciones...</p></div>
      </div>
    </div>

    <!-- MARCAS PERSONALES -->
    <div class="page" id="page-marcas">
      <p style="color:var(--muted);font-size:0.82rem;margin-bottom:20px;">Mejor tiempo registrado por prueba.</p>
      <div class="records-grid" id="records-grid">
        <div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">‚≠ê</div><p>Cargando...</p></div>
      </div>
    </div>

    <!-- M√çNIMOS -->
    <div class="page" id="page-minimos">
      <div style="display:flex;gap:12px;margin-bottom:20px;align-items:center;">
        <select id="filter-minimo-tipo" onchange="renderMinimos()" style="max-width:240px">
          <option value="">Todos los tipos</option>
          <option value="M√≠nima A Andaluc√≠a">M√≠nima A ‚Äî Andaluc√≠a</option>
          <option value="M√≠nima B Andaluc√≠a">M√≠nima B ‚Äî Andaluc√≠a</option>
          <option value="M√≠nima Espa√±a">M√≠nima Espa√±a</option>
        </select>
        <select id="filter-minimo-piscina" onchange="renderMinimos()" style="max-width:200px">
          <option value="">Todas las piscinas</option>
          <option value="25m">Piscina corta (25m)</option>
          <option value="50m">Piscina larga (50m)</option>
        </select>
      </div>
      <div class="min-table-wrap">
        <table>
          <thead><tr><th>Prueba</th><th>Piscina</th><th>M√≠nimo Objetivo</th><th>Tu MB</th><th>Progreso</th><th>Estado</th><th class="admin-action"></th></tr></thead>
          <tbody id="minimos-table"></tbody>
        </table>
      </div>
    </div>

    <!-- ADD TIEMPO (admin only) -->
    <div class="page" id="page-add-tiempo">
      <div class="form-card">
        <div class="form-card-title">üìã Datos del tiempo</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Prueba</label>
            <select id="at-prueba">
              <option value="">‚Äî Selecciona ‚Äî</option>
              <optgroup label="Libre"><option>50m Libre</option><option>100m Libre</option><option>200m Libre</option><option>400m Libre</option><option>800m Libre</option><option>1500m Libre</option></optgroup>
              <optgroup label="Espalda"><option>50m Espalda</option><option>100m Espalda</option><option>200m Espalda</option></optgroup>
              <optgroup label="Braza"><option>50m Braza</option><option>100m Braza</option><option>200m Braza</option></optgroup>
              <optgroup label="Mariposa"><option>50m Mariposa</option><option>100m Mariposa</option><option>200m Mariposa</option></optgroup>
              <optgroup label="Estilos"><option>100m Estilos</option><option>200m Estilos</option><option>400m Estilos</option></optgroup>
            </select>
          </div>
          <div class="form-group"><label>Piscina</label><select id="at-piscina"><option value="25m">Piscina corta (25m)</option><option value="50m">Piscina larga (50m)</option></select></div>
          <div class="form-group"><label>Tiempo (mm:ss.cc)</label><input type="text" id="at-tiempo" placeholder="0:25.34" /></div>
          <div class="form-group"><label>Fecha</label><input type="date" id="at-fecha" /></div>
          <div class="form-group"><label>Tipo</label><select id="at-tipo"><option value="entrenamiento">Entrenamiento</option><option value="competicion">Competici√≥n</option><option value="crono">Cronometrado</option></select></div>
          <div class="form-group"><label>Lugar / Club</label><input type="text" id="at-lugar" placeholder="Piscina Municipal..." /></div>
          <div class="form-group full"><label>Notas</label><textarea id="at-notas" placeholder="Sensaciones, condiciones, observaciones..."></textarea></div>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" onclick="addTiempo()">üíæ Guardar tiempo</button>
          <button class="btn btn-ghost" onclick="navigate('tiempos')">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- ADD COMPETICION (admin only) -->
    <div class="page" id="page-add-comp">
      <div class="form-card">
        <div class="form-card-title">üèÜ Datos de la competici√≥n</div>
        <div class="form-grid">
          <div class="form-group full"><label>Nombre</label><input type="text" id="ac-nombre" placeholder="Campeonato de Andaluc√≠a..." /></div>
          <div class="form-group"><label>Fecha de inicio</label><input type="date" id="ac-fecha-ini" /></div>
          <div class="form-group"><label>Fecha de fin</label><input type="date" id="ac-fecha-fin" /></div>
          <div class="form-group"><label>Lugar</label><input type="text" id="ac-lugar" placeholder="Sevilla..." /></div>
          <div class="form-group"><label>Tipo</label><select id="ac-tipo"><option>Local</option><option>Auton√≥mica</option><option>Nacional</option><option>Internacional</option></select></div>
          <div class="form-group full"><label>Notas</label><textarea id="ac-notas" placeholder="Descripci√≥n, club organizador..."></textarea></div>
        </div>
        <div id="comp-results-list" style="margin-bottom:16px;"></div>
        <button class="btn btn-ghost" onclick="addCompResult()" style="margin-bottom:16px;width:100%;">+ A√±adir resultado de prueba</button>
        <div class="form-actions">
          <button class="btn btn-primary" onclick="addCompeticion()">üíæ Guardar competici√≥n</button>
          <button class="btn btn-ghost" onclick="navigate('competiciones')">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- ADD MINIMO (admin only) -->
    <div class="page" id="page-add-minimo">
      <div class="form-card">
        <div class="form-card-title">üéØ Definir un m√≠nimo objetivo</div>
        <div class="form-grid cols3">
          <div class="form-group">
            <label>Prueba</label>
            <select id="am-prueba">
              <option value="">‚Äî Selecciona ‚Äî</option>
              <optgroup label="Libre"><option>50m Libre</option><option>100m Libre</option><option>200m Libre</option><option>400m Libre</option><option>800m Libre</option><option>1500m Libre</option></optgroup>
              <optgroup label="Espalda"><option>50m Espalda</option><option>100m Espalda</option><option>200m Espalda</option></optgroup>
              <optgroup label="Braza"><option>50m Braza</option><option>100m Braza</option><option>200m Braza</option></optgroup>
              <optgroup label="Mariposa"><option>50m Mariposa</option><option>100m Mariposa</option><option>200m Mariposa</option></optgroup>
              <optgroup label="Estilos"><option>100m Estilos</option><option>200m Estilos</option><option>400m Estilos</option></optgroup>
            </select>
          </div>
          <div class="form-group"><label>Piscina</label><select id="am-piscina"><option value="25m">Piscina corta (25m)</option><option value="50m">Piscina larga (50m)</option></select></div>
          <div class="form-group"><label>Tiempo m√≠nimo (mm:ss.cc)</label><input type="text" id="am-tiempo" placeholder="0:24.00" /></div>
          <div class="form-group">
            <label>Tipo de m√≠nimo</label>
            <select id="am-tipo">
              <option value="M√≠nima A Andaluc√≠a">M√≠nima A ‚Äî Andaluc√≠a</option>
              <option value="M√≠nima B Andaluc√≠a">M√≠nima B ‚Äî Andaluc√≠a</option>
              <option value="M√≠nima Espa√±a">M√≠nima Espa√±a</option>
            </select>
          </div>
          <div class="form-group"><label>Temporada</label><input type="text" id="am-temporada" placeholder="2024/25" /></div>
          <div class="form-group"><label>Notas</label><input type="text" id="am-notas" placeholder="Observaciones..." /></div>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" onclick="addMinimo()">üíæ Guardar m√≠nimo</button>
          <button class="btn btn-ghost" onclick="navigate('minimos')">Cancelar</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ADMIN BAR -->
<div id="admin-bar">
  <div class="admin-status">
    <div class="admin-dot" id="admin-dot"></div>
    <span id="admin-status-text">Modo visualizaci√≥n</span>
  </div>
  <div style="display:flex;gap:8px">
    <button class="admin-btn" id="admin-login-btn" onclick="openAdminModal()">üîê Admin</button>
    <button class="admin-btn exit" id="admin-exit-btn" onclick="exitAdmin()" style="display:none">‚úï Salir</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, setDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ======= CONFIG =======
const ADMIN_PASSWORD = "13Mayo2011"; // ‚Üê CAMBIA ESTO

const firebaseConfig = {
  apiKey: "AIzaSyAJ2RAlkFjM2xh7nCPXxPDWLRkAEUjJOew",
  authDomain: "natacion-cmis.firebaseapp.com",
  projectId: "natacion-cmis",
  storageBucket: "natacion-cmis.firebasestorage.app",
  messagingSenderId: "549731749014",
  appId: "1:549731749014:web:2180c853689de487c6c6b7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ======= STATE =======
let state = { tiempos: [], competiciones: [], minimos: [] };
let isAdmin = false;
let compResultsTemp = [];

// ======= FIRESTORE LISTENERS =======
function setSyncing(syncing, error) {
  const dot = document.getElementById('sync-dot');
  const txt = document.getElementById('sync-text');
  dot.className = 'sync-dot' + (syncing ? ' syncing' : error ? ' error' : '');
  txt.textContent = syncing ? 'Sincronizando...' : error ? 'Error de conexi√≥n' : 'Sincronizado';
}

// Listen tiempos
onSnapshot(query(collection(db, 'tiempos'), orderBy('fecha', 'desc')), (snap) => {
  state.tiempos = snap.docs.map(d => ({ ...d.data(), _id: d.id }));
  setSyncing(false);
  refreshCurrentPage();
}, () => setSyncing(false, true));

// Listen competiciones
onSnapshot(query(collection(db, 'competiciones'), orderBy('fechaIni', 'desc')), (snap) => {
  state.competiciones = snap.docs.map(d => ({ ...d.data(), _id: d.id }));
  refreshCurrentPage();
}, () => {});

// Listen minimos
onSnapshot(collection(db, 'minimos'), (snap) => {
  state.minimos = snap.docs.map(d => ({ ...d.data(), _id: d.id }));
  refreshCurrentPage();
  hideLoading();
}, () => { hideLoading(); });

function hideLoading() {
  document.getElementById('loading-screen').style.display = 'none';
}

// Timeout de seguridad: si Firebase no responde en 7s, carga la app igualmente
setTimeout(() => {
  const ls = document.getElementById('loading-screen');
  if (ls && ls.style.display !== 'none') {
    hideLoading();
    const dot = document.getElementById('sync-dot');
    const txt = document.getElementById('sync-text');
    if (dot) { dot.className = 'sync-dot error'; }
    if (txt) { txt.textContent = 'Sin conexi√≥n ‚Äî configura Firestore'; }
    renderDashboard();
  }
}, 7000);

// ======= ADMIN =======
window.openAdminModal = function() {
  document.getElementById('admin-modal').classList.add('show');
  document.getElementById('admin-password-input').value = '';
  document.getElementById('modal-error').classList.remove('show');
  setTimeout(() => document.getElementById('admin-password-input').focus(), 100);
};

window.closeAdminModal = function() {
  document.getElementById('admin-modal').classList.remove('show');
};

window.checkPassword = function() {
  const val = document.getElementById('admin-password-input').value;
  if (val === ADMIN_PASSWORD) {
    isAdmin = true;
    closeAdminModal();
    activateAdmin();
  } else {
    document.getElementById('modal-error').classList.add('show');
    document.getElementById('admin-password-input').value = '';
    document.getElementById('admin-password-input').focus();
  }
};

function activateAdmin() {
  document.getElementById('admin-dot').classList.add('on');
  document.getElementById('admin-status-text').textContent = 'Modo administrador activo';
  document.getElementById('admin-bar').classList.add('admin-active');
  document.getElementById('admin-login-btn').style.display = 'none';
  document.getElementById('admin-exit-btn').style.display = 'block';
  document.getElementById('nav-admin-section').classList.add('show');
  document.querySelectorAll('.admin-action').forEach(el => el.classList.add('show'));
  document.querySelectorAll('.admin-action-block').forEach(el => el.classList.add('show'));
  showToast('üîê Modo admin activado');
  refreshCurrentPage();
}

window.exitAdmin = function() {
  isAdmin = false;
  document.getElementById('admin-dot').classList.remove('on');
  document.getElementById('admin-status-text').textContent = 'Modo visualizaci√≥n';
  document.getElementById('admin-bar').classList.remove('admin-active');
  document.getElementById('admin-login-btn').style.display = 'block';
  document.getElementById('admin-exit-btn').style.display = 'none';
  document.getElementById('nav-admin-section').classList.remove('show');
  document.querySelectorAll('.admin-action').forEach(el => el.classList.remove('show'));
  document.querySelectorAll('.admin-action-block').forEach(el => el.classList.remove('show'));
  navigate('dashboard');
};

// ======= NAVIGATION =======
const pageTitles = {
  dashboard:'Dashboard', tiempos:'Mis Tiempos', competiciones:'Competiciones',
  marcas:'Marcas Personales', minimos:'M√≠nimos Objetivo',
  'add-tiempo':'A√±adir Tiempo', 'add-comp':'Nueva Competici√≥n', 'add-minimo':'A√±adir M√≠nimo'
};

let currentPage = 'dashboard';
window.navigate = function(page) {
  if (['add-tiempo','add-comp','add-minimo'].includes(page) && !isAdmin) return;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const el = document.getElementById('page-' + page);
  if (!el) return;
  el.classList.add('active');
  const navEl = document.querySelector(`.nav-item[onclick="navigate('${page}')"]`);
  if (navEl) navEl.classList.add('active');
  document.getElementById('page-title').textContent = pageTitles[page] || '';
  currentPage = page;
  if (page === 'add-comp') resetCompForm();
  renderPage(page);
};

function refreshCurrentPage() { renderPage(currentPage); }

function renderPage(page) {
  if (page === 'dashboard') renderDashboard();
  if (page === 'tiempos') renderTiempos();
  if (page === 'competiciones') renderCompeticiones();
  if (page === 'marcas') renderMarcas();
  if (page === 'minimos') renderMinimos();
}

// ======= TIME UTILS =======
function parseTime(str) {
  str = String(str).trim();
  const parts = str.split(':');
  let total = parts.length === 2
    ? parseFloat(parts[0]) * 60 + parseFloat(parts[1])
    : parseFloat(parts[0]);
  return isNaN(total) ? null : total;
}

function formatTime(secs) {
  if (secs === null || secs === undefined) return '‚Äî';
  const m = Math.floor(secs / 60);
  const s = (secs % 60).toFixed(2).padStart(5, '0');
  return m > 0 ? `${m}:${s}` : `${Number(secs).toFixed(2)}`;
}

function tipoBadge(tipo) {
  if (tipo === 'competicion') return 'badge-gold';
  if (tipo === 'crono') return 'badge-blue';
  return 'badge-gray';
}

function tipominBadge(tipo) {
  if (tipo === 'M√≠nima A Andaluc√≠a') return 'badge-gold';
  if (tipo === 'M√≠nima B Andaluc√≠a') return 'badge-blue';
  if (tipo === 'M√≠nima Espa√±a') return 'badge-red';
  return 'badge-gray';
}

// ======= PBs =======
function getPBs() {
  const pbs = {};
  state.tiempos.forEach(t => {
    const key = t.prueba + '|' + t.piscina;
    if (!pbs[key] || t.tiempo < pbs[key].tiempo) pbs[key] = { ...t };
  });
  return pbs;
}

function isPBTime(t) {
  const pbs = getPBs();
  const key = t.prueba + '|' + t.piscina;
  return pbs[key] && pbs[key]._id === t._id;
}

// ======= DASHBOARD =======
function renderDashboard() {
  document.getElementById('stat-total').textContent = state.tiempos.length;
  document.getElementById('stat-comps').textContent = state.competiciones.length;
  document.getElementById('stat-mins').textContent = state.minimos.length;
  document.getElementById('stat-pbs').textContent = Object.keys(getPBs()).length;

  const recent = state.tiempos.slice(0, 8);
  const tbody = document.getElementById('dashboard-table');
  tbody.innerHTML = recent.length === 0
    ? '<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">üåä</div><p>No hay tiempos registrados a√∫n.</p></div></td></tr>'
    : recent.map(t => `<tr>
        <td>${t.fecha}</td><td>${t.prueba}</td>
        <td><span class="badge badge-gray">${t.piscina}</span></td>
        <td><span class="time-value">${formatTime(t.tiempo)}</span>${isPBTime(t) ? '<span class="pb-tag">‚≠ê MB</span>' : ''}</td>
        <td><span class="badge ${tipoBadge(t.tipo)}">${t.tipo}</span></td>
        <td style="color:var(--muted);font-size:0.8rem">${t.notas ? t.notas.slice(0,40) + (t.notas.length>40?'‚Ä¶':'') : '‚Äî'}</td>
      </tr>`).join('');

  const today = new Date();
  const upcoming = state.competiciones.filter(c => new Date(c.fechaFin || c.fechaIni) >= today).slice(0, 3);
  const dc = document.getElementById('dashboard-comps');
  dc.innerHTML = upcoming.length === 0
    ? '<div class="empty-state" style="padding:30px"><div class="empty-icon">üìÖ</div><p>No hay competiciones pr√≥ximas.</p></div>'
    : '<div class="comp-list">' + upcoming.map(c => compCardHTML(c, true)).join('') + '</div>';
}

// ======= TIEMPOS =======
window.addTiempo = async function() {
  const prueba = document.getElementById('at-prueba').value;
  const piscina = document.getElementById('at-piscina').value;
  const tiempoStr = document.getElementById('at-tiempo').value;
  const fecha = document.getElementById('at-fecha').value;
  const tipo = document.getElementById('at-tipo').value;
  const lugar = document.getElementById('at-lugar').value;
  const notas = document.getElementById('at-notas').value;

  if (!prueba) { alert('Selecciona una prueba'); return; }
  const tiempo = parseTime(tiempoStr);
  if (!tiempo) { alert('Introduce un tiempo v√°lido (ej: 1:23.45 o 25.34)'); return; }
  if (!fecha) { alert('Introduce una fecha'); return; }

  setSyncing(true);
  await addDoc(collection(db, 'tiempos'), { prueba, piscina, tiempo, fecha, tipo, lugar, notas, createdAt: Date.now() });
  setSyncing(false);
  showToast('‚úÖ Tiempo guardado');
  ['at-tiempo','at-notas','at-lugar'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('at-prueba').value = '';
  navigate('tiempos');
};

function renderTiempos() {
  const filterPrueba = document.getElementById('filter-prueba').value;
  const filterPiscina = document.getElementById('filter-piscina').value;
  const filterTipo = document.getElementById('filter-tipo').value;

  const pruebas = [...new Set(state.tiempos.map(t => t.prueba))];
  const sel = document.getElementById('filter-prueba');
  const cur = sel.value;
  sel.innerHTML = '<option value="">Todas las pruebas</option>' + pruebas.map(p => `<option value="${p}" ${p===cur?'selected':''}>${p}</option>`).join('');

  let filtered = [...state.tiempos];
  if (filterPrueba) filtered = filtered.filter(t => t.prueba === filterPrueba);
  if (filterPiscina) filtered = filtered.filter(t => t.piscina === filterPiscina);
  if (filterTipo) filtered = filtered.filter(t => t.tipo === filterTipo);

  const tbody = document.getElementById('tiempos-table');
  tbody.innerHTML = filtered.length === 0
    ? '<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">üåä</div><p>No hay tiempos para estos filtros.</p></div></td></tr>'
    : filtered.map(t => `<tr>
        <td style="font-size:0.82rem">${t.fecha}</td><td>${t.prueba}</td>
        <td><span class="badge badge-gray">${t.piscina}</span></td>
        <td><span class="time-value">${formatTime(t.tiempo)}</span>${isPBTime(t)?'<span class="pb-tag">‚≠ê MB</span>':''}</td>
        <td><span class="badge ${tipoBadge(t.tipo)}">${t.tipo}</span></td>
        <td style="font-size:0.8rem;color:var(--muted)">${t.lugar||'‚Äî'}</td>
        <td style="font-size:0.78rem;color:var(--muted);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.notas||'‚Äî'}</td>
        ${isAdmin ? `<td><button class="btn btn-danger" onclick="deleteTiempo('${t._id}')">üóë</button></td>` : '<td></td>'}
      </tr>`).join('');
}

window.deleteTiempo = async function(id) {
  if (!confirm('¬øEliminar este tiempo?')) return;
  setSyncing(true);
  await deleteDoc(doc(db, 'tiempos', id));
  setSyncing(false);
  showToast('üóëÔ∏è Tiempo eliminado');
};

// ======= M√çNIMOS =======
window.addMinimo = async function() {
  const prueba = document.getElementById('am-prueba').value;
  const piscina = document.getElementById('am-piscina').value;
  const tiempoStr = document.getElementById('am-tiempo').value;
  const tipo = document.getElementById('am-tipo').value;
  const temporada = document.getElementById('am-temporada').value;
  const notas = document.getElementById('am-notas').value;

  if (!prueba) { alert('Selecciona una prueba'); return; }
  const tiempo = parseTime(tiempoStr);
  if (!tiempo) { alert('Introduce un tiempo v√°lido'); return; }

  // Use prueba+piscina+tipo as document ID so it overwrites
  const docId = `${prueba}|${piscina}|${tipo}`.replace(/[^a-zA-Z0-9|√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]/g, '_');
  setSyncing(true);
  await setDoc(doc(db, 'minimos', docId), { prueba, piscina, tiempo, tipo, temporada, notas });
  setSyncing(false);
  showToast('üéØ M√≠nimo guardado');
  document.getElementById('am-tiempo').value = '';
  document.getElementById('am-prueba').value = '';
  navigate('minimos');
};

function renderMinimos() {
  const tbody = document.getElementById('minimos-table');
  const filterTipo = document.getElementById('filter-minimo-tipo')?.value || '';
  const filterPiscina = document.getElementById('filter-minimo-piscina')?.value || '';

  let filtered = state.minimos;
  if (filterTipo) filtered = filtered.filter(m => m.tipo === filterTipo);
  if (filterPiscina) filtered = filtered.filter(m => m.piscina === filterPiscina);

  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">üéØ</div><p>No hay m√≠nimos para estos filtros.</p></div></td></tr>';
    return;
  }
  const pbs = getPBs();

  tbody.innerHTML = filtered.map(m => {
    const pb = pbs[m.prueba + '|' + m.piscina];
    const pbTime = pb ? pb.tiempo : null;
    let pct = 0, statusHTML = '<span class="badge badge-gray">Sin MB</span>';
    if (pbTime !== null) {
      pct = pbTime <= m.tiempo ? 100 : Math.min(99, Math.max(0, (m.tiempo / pbTime) * 100));
      if (pbTime <= m.tiempo) {
        statusHTML = '<span class="badge badge-green">‚úì Conseguido</span>';
      } else {
        const over = ((pbTime - m.tiempo) / m.tiempo * 100).toFixed(1);
        statusHTML = `<span class="badge badge-red">Faltan ${over}%</span>`;
      }
    }
    return `<tr>
      <td><strong>${m.prueba}</strong><br><span class="badge ${tipominBadge(m.tipo)}" style="margin-top:4px">${m.tipo}</span></td>
      <td><span class="badge badge-gray">${m.piscina}</span></td>
      <td><span class="time-value" style="color:var(--accent)">${formatTime(m.tiempo)}</span></td>
      <td><span class="time-value">${pbTime !== null ? formatTime(pbTime) : '‚Äî'}</span></td>
      <td style="min-width:120px"><div class="progress-bar-wrap"><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${pct}%"></div></div><span class="progress-pct">${pct.toFixed(0)}%</span></div></td>
      <td>${statusHTML}</td>
      ${isAdmin ? `<td><button class="btn btn-danger" onclick="deleteMinimo('${m._id}')">üóë</button></td>` : '<td></td>'}
    </tr>`;
  }).join('');
}

window.deleteMinimo = async function(id) {
  if (!confirm('¬øEliminar este m√≠nimo?')) return;
  setSyncing(true);
  await deleteDoc(doc(db, 'minimos', id));
  setSyncing(false);
  showToast('üóëÔ∏è M√≠nimo eliminado');
};

// ======= MARCAS =======
function renderMarcas() {
  const pbs = getPBs();
  const grid = document.getElementById('records-grid');
  const keys = Object.keys(pbs);
  if (keys.length === 0) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">‚≠ê</div><p>A√∫n no hay marcas personales.</p></div>';
    return;
  }
  grid.innerHTML = keys.map(key => {
    const t = pbs[key];
    const min = state.minimos.find(m => m.prueba === t.prueba && m.piscina === t.piscina);
    let minHTML = '';
    if (min) {
      const diff = t.tiempo - min.tiempo;
      const diffStr = diff >= 0
        ? `<span class="diff-tag diff-pos">+${formatTime(Math.abs(diff))} sobre el m√≠nimo</span>`
        : `<span class="diff-tag diff-neg">${formatTime(Math.abs(diff))} por debajo ‚úì</span>`;
      minHTML = `<div class="record-min"><div class="record-min-label">M√≠nimo: ${min.tipo}</div><div class="record-min-val">${formatTime(min.tiempo)}</div>${diffStr}</div>`;
    }
    return `<div class="record-card">
      <div class="record-event">${t.prueba} ¬∑ ${t.piscina}</div>
      <div class="record-time">${formatTime(t.tiempo)}</div>
      <div class="record-date">üìÖ ${t.fecha} ¬∑ ${t.lugar || t.tipo}</div>
      ${minHTML}
    </div>`;
  }).join('');
}

// ======= COMPETICIONES =======
window.addCompResult = function() {
  compResultsTemp.push({ prueba: '50m Libre', piscina: '25m', tiempo: '', puesto: '' });
  renderCompResultInputs();
};

function renderCompResultInputs() {
  const el = document.getElementById('comp-results-list');
  if (!compResultsTemp.length) { el.innerHTML = ''; return; }
  el.innerHTML = compResultsTemp.map((r, i) => `
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;margin-bottom:10px">
        <span style="font-size:0.72rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase">Prueba ${i+1}</span>
        <button onclick="removeCompResult(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:0.8rem">‚úï Quitar</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px">
        <div><label style="font-size:0.65rem;color:var(--muted)">PRUEBA</label>
          <select onchange="updateCompResult(${i},'prueba',this.value)" style="margin-top:4px">
            <option>50m Libre</option><option>100m Libre</option><option>200m Libre</option><option>400m Libre</option><option>800m Libre</option><option>1500m Libre</option>
            <option>50m Espalda</option><option>100m Espalda</option><option>200m Espalda</option>
            <option>50m Braza</option><option>100m Braza</option><option>200m Braza</option>
            <option>50m Mariposa</option><option>100m Mariposa</option><option>200m Mariposa</option>
            <option>100m Estilos</option><option>200m Estilos</option><option>400m Estilos</option>
          </select></div>
        <div><label style="font-size:0.65rem;color:var(--muted)">PISCINA</label>
          <select onchange="updateCompResult(${i},'piscina',this.value)" style="margin-top:4px">
            <option value="25m">25m</option><option value="50m">50m</option>
          </select></div>
        <div><label style="font-size:0.65rem;color:var(--muted)">TIEMPO</label>
          <input type="text" placeholder="1:23.45" value="${r.tiempo}" onchange="updateCompResult(${i},'tiempo',this.value)" style="margin-top:4px"></div>
        <div><label style="font-size:0.65rem;color:var(--muted)">PUESTO</label>
          <input type="text" placeholder="1¬∫" value="${r.puesto}" onchange="updateCompResult(${i},'puesto',this.value)" style="margin-top:4px"></div>
      </div>
    </div>`).join('');
}

window.updateCompResult = (i, f, v) => compResultsTemp[i][f] = v;
window.removeCompResult = (i) => { compResultsTemp.splice(i, 1); renderCompResultInputs(); };

function resetCompForm() {
  compResultsTemp = [];
  renderCompResultInputs();
  ['ac-nombre','ac-lugar','ac-notas'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('ac-fecha-ini').value = '';
  document.getElementById('ac-fecha-fin').value = '';
}

window.addCompeticion = async function() {
  const nombre = document.getElementById('ac-nombre').value.trim();
  const fechaIni = document.getElementById('ac-fecha-ini').value;
  const fechaFin = document.getElementById('ac-fecha-fin').value;
  const lugar = document.getElementById('ac-lugar').value.trim();
  const tipo = document.getElementById('ac-tipo').value;
  const notas = document.getElementById('ac-notas').value;

  if (!nombre) { alert('Introduce el nombre'); return; }
  if (!fechaIni) { alert('Introduce la fecha'); return; }

  const resultados = compResultsTemp.map(r => ({ ...r, tiempoSeg: parseTime(r.tiempo) || null }));
  setSyncing(true);
  await addDoc(collection(db, 'competiciones'), { nombre, fechaIni, fechaFin, lugar, tipo, notas, resultados, createdAt: Date.now() });

  // Also add times
  for (const r of resultados) {
    if (r.tiempoSeg) {
      await addDoc(collection(db, 'tiempos'), { prueba: r.prueba, piscina: r.piscina, tiempo: r.tiempoSeg, fecha: fechaIni, tipo: 'competicion', lugar: nombre, notas: r.puesto ? `Puesto: ${r.puesto}` : '', createdAt: Date.now() });
    }
  }
  setSyncing(false);
  showToast('üèÜ Competici√≥n guardada');
  navigate('competiciones');
};

function renderCompeticiones() {
  const list = document.getElementById('comp-list');
  if (!state.competiciones.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-icon">üèÜ</div><p>No hay competiciones registradas.</p></div>';
    return;
  }
  list.innerHTML = state.competiciones.map(c => compCardHTML(c, false)).join('');
}

function compCardHTML(c, compact) {
  const today = new Date();
  const fi = new Date(c.fechaIni), ff = c.fechaFin ? new Date(c.fechaFin) : fi;
  const statusBadge = ff < today ? '<span class="badge badge-gray">Finalizada</span>' : fi <= today ? '<span class="badge badge-green">En curso</span>' : '<span class="badge badge-blue">Pr√≥xima</span>';
  const resultsHTML = c.resultados?.length ? c.resultados.map(r => `
    <div class="comp-result-tag">
      <span class="ev">${r.prueba}</span>
      <span class="tm">${r.tiempoSeg ? formatTime(r.tiempoSeg) : r.tiempo}</span>
      ${r.puesto ? `<span style="font-size:0.7rem;color:var(--gold)">${r.puesto}</span>` : ''}
    </div>`).join('') : '';

  return `<div class="comp-card">
    <div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
        <div class="comp-name">${c.nombre}</div>${statusBadge}<span class="badge badge-gray">${c.tipo}</span>
      </div>
      <div class="comp-meta">
        ${c.fechaIni ? `<span>üìÖ ${c.fechaIni}${c.fechaFin && c.fechaFin!==c.fechaIni?' ‚Üí '+c.fechaFin:''}</span>` : ''}
        ${c.lugar ? `<span>üìç ${c.lugar}</span>` : ''}
      </div>
      ${resultsHTML ? `<div class="comp-results">${resultsHTML}</div>` : ''}
      ${c.notas && !compact ? `<div style="margin-top:10px;font-size:0.8rem;color:var(--muted)">${c.notas}</div>` : ''}
    </div>
    ${!compact && isAdmin ? `<div class="comp-actions"><button class="btn btn-danger" onclick="deleteComp('${c._id}')">üóë</button></div>` : ''}
  </div>`;
}

window.deleteComp = async function(id) {
  if (!confirm('¬øEliminar esta competici√≥n?')) return;
  setSyncing(true);
  await deleteDoc(doc(db, 'competiciones', id));
  setSyncing(false);
  showToast('üóëÔ∏è Competici√≥n eliminada');
};

// ======= TOAST =======
window.showToast = function(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
};

// Init date
document.getElementById('at-fecha').value = new Date().toISOString().slice(0,10);
setSyncing(true);
</script>
</body>
</html>
